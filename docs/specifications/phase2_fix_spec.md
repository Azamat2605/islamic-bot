# Phase 2 Fix Specification: Inline Keyboard Migration

## –û–±–∑–æ—Ä

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –Ω–∞ inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (Phase 1) –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –ø–æ–¥–º–æ–¥—É–ª—è—Ö. –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –±–æ—Ç–∞.

## –ü—Ä–æ–±–ª–µ–º—ã Phase 1

1. **AI Assistant**: –ö–Ω–æ–ø–∫–∞ "ü§ñ –ò—Å–ª–∞–º—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫" (`callback_data="islamic_assistant"`) –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥, –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ" –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–∫—Ü–∏—è.
2. **Profile**: –ö–Ω–æ–ø–∫–∞ "üë§ –ü—Ä–æ—Ñ–∏–ª—å" (`callback_data="profile_settings"`) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "Available via command", –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è —Å inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π.
3. **Halal Section**: –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "üè† –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ" (—É—Å—Ç–∞—Ä–µ–≤—à–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ), –≤–º–µ—Å—Ç–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–∞–∑–∞–¥ —á–µ—Ä–µ–∑ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ inline-—Å–æ–æ–±—â–µ–Ω–∏—è.
4. **Prayer Section**: –ö–Ω–æ–ø–∫–∞ "Back to Menu" –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ —Ä–∞–∑–¥–µ–ª–∞ –Ω–∞–º–∞–∑–∞ (–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –ø–æ–¥–º–µ–Ω—é "–ù–µ–¥–µ–ª—è").
5. **Architectural Inconsistency**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –µ–¥–∏–Ω–æ–≥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏.

## –¢–∞–±–ª–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è Callback ‚Üí –û–±—Ä–∞–±–æ—Ç—á–∏–∫ ‚Üí –ò–∑–º–µ–Ω–µ–Ω–∏—è

| –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (Callback) | –¶–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ | –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å | –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è |
|-------------------------|--------------------------|----------------|-----------------------|
| `islamic_assistant` | `bot/handlers/sections/ai_assistant.py` | –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ `F.text == __("ü§ñ –ò—Å–ª–∞–º—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫")` | –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `@router.callback_query(F.data == "islamic_assistant")` –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π |
| `profile_settings` | `bot/handlers/sections/profile_handlers.py` | –°—É—â–µ—Å—Ç–≤—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `profile_settings_handler`, –Ω–æ –æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç alert –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `/profile` | –ò–∑–º–µ–Ω–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è —Å inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π `profile_keyboard` |
| `prayer_schedule` | `bot/handlers/sections/prayer_schedule_handlers.py` | –û–±—Ä–∞–±–æ—Ç—á–∏–∫ `handle_prayer_main` —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ `F.data == "prayer_main"` –∏ `F.data == "prayer_schedule"` | –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É `callback_data="prayer_schedule"` –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –µ—Å—Ç—å, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é) |
| `halal_places` | `bot/handlers/sections/halal_places_handlers.py` | –û–±—Ä–∞–±–æ—Ç—á–∏–∫ `halal_places_main_handler` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏ `F.text` –∏ `F.data == "halal_places"` | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `callback.message.edit_text` –≤–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è |
| `education` | `bot/handlers/sections/education_handlers.py` | –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ | –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ callback, –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |
| `knowledge` | `bot/handlers/sections/knowledge_handlers.py` | –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ | –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ callback, –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |
| `events_calendar` | `bot/handlers/sections/events_calendar_handlers.py` | –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ | –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ callback, –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |

## –°—Ç–∞–Ω–¥–∞—Ä—Ç –ª–æ–≥–∏–∫–∏ –≤—Ö–æ–¥–∞ –≤ —Ä–∞–∑–¥–µ–ª

**–ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –¥–æ–ª–∂–µ–Ω —Å–ª–µ–¥–æ–≤–∞—Ç—å —ç—Ç–æ–º—É —à–∞–±–ª–æ–Ω—É:**

```python
@router.callback_query(F.data == "section_callback")
async def section_entry_handler(callback: CallbackQuery, session: AsyncSession):
    """
    –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞ –≤ —Ä–∞–∑–¥–µ–ª –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é.
    """
    # 1. –ü–æ–ª—É—á–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∫–æ–Ω—Ç–µ–∫—Å—Ç)
    user = await get_user_by_telegram_id(session, callback.from_user.id)
    settings = await get_user_settings(session, user.id)
    
    # 2. –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–∫—Å—Ç, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞)
    section_text = get_section_text(user, settings)  # –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
    section_keyboard = get_section_main_keyboard()   # Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ä–∞–∑–¥–µ–ª–∞
    
    # 3. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ù–ò–ö–û–ì–î–ê –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–æ–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
    await callback.message.edit_text(
        text=section_text,
        reply_markup=section_keyboard,
        parse_mode="Markdown"  # –∏–ª–∏ HTML, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    )
    
    # 4. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É callback
    await callback.answer()
```

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**
- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `callback.message.edit_text()` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (`callback.message.answer()`) –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏
- –í—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–π—Ç–µ `await callback.answer()` –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–∫—Å—Ç–∞ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –≤—Å–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞

## –°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"

**–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥":**

```python
# –í –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞—Ö (inline/keyboards/):
def get_section_back_kb(target: str = "main") -> InlineKeyboardMarkup:
    """
    –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –¥–ª—è –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–æ–≤.
    
    Args:
        target: "main" - –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, "parent" - –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ –º–µ–Ω—é —Ä–∞–∑–¥–µ–ª–∞
    """
    builder = InlineKeyboardBuilder()
    
    if target == "main":
        builder.button(
            text=_("üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"),
            callback_data="main_menu"  # –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π callback –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
        )
    else:
        builder.button(
            text=_("üîô –ù–∞–∑–∞–¥"),
            callback_data="section_parent"  # –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π callback –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞
        )
    
    return builder.as_markup()

# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö:
@router.callback_query(F.data == "main_menu")
async def back_to_main_menu(callback: CallbackQuery, session: AsyncSession):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
    """
    from bot.keyboards.main_menu import main_menu_keyboard
    
    # –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    menu_text = _(
        "üè† *–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
    )
    
    await callback.message.edit_text(
        text=menu_text,
        reply_markup=main_menu_keyboard(),
        parse_mode="Markdown"
    )
    await callback.answer()
```

**–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ù–∞–∑–∞–¥":**
1. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ emoji + —Ç–µ–∫—Å—Ç ("üîô –ù–∞–∑–∞–¥" –∏–ª–∏ "üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
2. –í—Å–µ–≥–¥–∞ —Ä–∞–∑–º–µ—â–∞–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ä—è–¥—É (adjust(1))
3. –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–¥–∏–Ω—ã–π callback `"main_menu"`
4. –î–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ —Ä–∞–∑–¥–µ–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ callbacks (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"halal_back_to_categories"`)

## –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π (Phase 2)

### –≠—Ç–∞–ø 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ AI Assistant
1. –î–æ–±–∞–≤–∏—Ç—å –≤ `ai_assistant.py` –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è `F.data == "islamic_assistant"`
2. –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `callback.message.edit_text()` —Å `get_ai_menu_kb()`
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (FSM) —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Ä–∞–∑–¥–µ–ª

### –≠—Ç–∞–ø 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Profile
1. –ò–∑–º–µ–Ω–∏—Ç—å `profile_settings_handler` –≤ `profile_handlers.py`
2. –ó–∞–º–µ–Ω–∏—Ç—å alert –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å `profile_keyboard`
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é `get_profile_text()` –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞

### –≠—Ç–∞–ø 3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Halal Section
1. –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `back_handler` –≤ `halal_places_handlers.py`
2. –ó–∞–º–µ–Ω–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ `callback.message.edit_text()` —Å –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è "–ù–∞–∑–∞–¥" –≤ –º–æ–¥—É–ª–µ (`from_state` –∑–Ω–∞—á–µ–Ω–∏—è)

### –≠—Ç–∞–ø 4: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Prayer Section
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∫–Ω–æ–ø–∫–∏ "Back to Menu" –≤ –≥–ª–∞–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –Ω–∞–º–∞–∑–∞
2. –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤ `get_prayer_main_kb()` –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ callback `"main_menu"` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –≠—Ç–∞–ø 5: –ê—É–¥–∏—Ç –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `education_handlers.py`, `knowledge_handlers.py`, `events_calendar_handlers.py`
2. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞, –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
3. –ü—Ä–∏–≤–µ—Å—Ç–∏ –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã –∫ –µ–¥–∏–Ω–æ–º—É —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É –≤—Ö–æ–¥–∞

### –≠—Ç–∞–ø 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é –º–µ–∂–¥—É –≤—Å–µ–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –∫–Ω–æ–ø–æ–∫ "–ù–∞–∑–∞–¥" –≤–æ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

- [ ] AI Assistant: –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `callback_query(F.data == "islamic_assistant")`
- [ ] Profile: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ `profile_settings_handler` —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç alert
- [ ] Halal: –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `callback.message.edit_text()` –≤–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞
- [ ] Prayer: –ì–ª–∞–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–Ω–æ–ø–∫—É "Back to Menu"
- [ ] Education: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –¥–æ–±–∞–≤–ª–µ–Ω –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É
- [ ] Knowledge: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –¥–æ–±–∞–≤–ª–µ–Ω –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É
- [ ] Events: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –¥–æ–±–∞–≤–ª–µ–Ω –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É
- [ ] –í—Å–µ —Ä–∞–∑–¥–µ–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `main_menu` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É –≤—Å–µ–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏
- [ ] –õ–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –æ—à–∏–±–æ–∫ "Message is not modified"

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Callback Data –°–æ–≥–ª–∞—à–µ–Ω–∏—è
- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é: `section_name` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `islamic_assistant`, `profile_settings`)
- –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é: `main_menu`
- –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è: `section_action:param` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `prayer_week:7`)

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
```python
try:
    await callback.message.edit_text(...)
except aiogram.exceptions.TelegramBadRequest as e:
    if "Message is not modified" in str(e):
        # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å - —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ—Ç –∂–µ –∫–æ–Ω—Ç–µ–Ω—Ç
        pass
    else:
        logger.error(f"Edit text error: {e}")
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:
- –í—Ö–æ–¥ –≤ —Ä–∞–∑–¥–µ–ª (user_id, callback_data)
- –û—à–∏–±–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π (FSM)

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Phase 2 —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä –≤–æ –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö –±–æ—Ç–∞. –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—É–¥–µ—Ç –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –ø–ª–∞–≤–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–∏—à–Ω–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

**–°—Ä–æ–∫–∏:** 2-3 –¥–Ω—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π  
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü–æ–ª–Ω–æ–µ —Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
